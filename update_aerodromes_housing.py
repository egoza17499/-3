import psycopg2
import logging
from config import DATABASE_URL

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# ============================================================================
# –ê–≠–†–û–î–†–û–ú–´ –ö–û–¢–û–†–´–ï –û–ë–ï–°–ü–ï–ß–ò–í–ê–Æ–¢–°–Ø –ñ–ò–õ–¨–ï–ú –ú–û –†–§
# ============================================================================
AERODROMES_PROVIDED = {
    '–¶–í–û': [
        '–ë–∞–ª–∞—à–∏—Ö–∞', '–ë–µ–ª–∞—è', '–ë–∏—à–∫–µ–∫', '–ß–µ–ª—è–±–∏–Ω—Å–∫', '–î—É—à–∞–Ω–±–µ', '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
        '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '–û—Ä–µ–Ω–±—É—Ä–≥', '–ü—Ä–∏–æ–∑–µ—Ä—Å–∫', '–°–∞—Ä–∞—Ç–æ–≤',
    ],
    '–Æ–í–û': [
        '–ê—Å—Ç—Ä–∞—Ö–∞–Ω—å', '–ê—Ä–º–∞–≤–∏—Ä', '–ê—Ö—Ç—É–±–∏–Ω—Å–∫', '–ë–µ–ª—å–±–µ–∫', '–ì–≤–∞—Ä–¥–µ–π—Å–∫–æ–µ',
        '–ú–∏–ª–ª–µ—Ä–æ–≤–æ', '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É', '–°–∞–∫–∏', '–¢—É–∞–ø—Å–µ',
    ],
    '–ó–í–û': [
        '–í–æ—Ä–æ–Ω–µ–∂', '–ò–≤–∞–Ω–æ–≤–æ', '–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥', '–ö—É–±–∏–Ω–∫–∞', '–õ–∏–ø–µ—Ü–∫',
        '–ü—Å–∫–æ–≤', '–ü—É—à–∫–∏–Ω', '–†—è–∑–∞–Ω—å', '–¢–≤–µ—Ä—å', '–¢–∞–º–±–æ–≤', '–¢–æ—Ä–∂–æ–∫',
        '–®–∞–π–∫–æ–≤–∫–∞', '–°–∞–≤–∞—Å–ª–µ–π–∫–∞', '–ú–æ—Å–∫–≤–∞',
    ],
    '–í–í–û': [
        '–í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫', '–î–æ–º–Ω–∞', '–ö–æ–º—Å–æ–º–æ–ª—å—Å–∫-–Ω–∞-–ê–º—É—Ä–µ', '–ù–∏–∫–æ–ª–∞–µ–≤–∫–∞',
        '–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫-–ö–∞–º—á–∞—Ç—Å–∫–∏–π', '–•–∞–±–∞—Ä–æ–≤—Å–∫', '–£–∫—Ä–∞–∏–Ω–∫–∞', '–£–ª–∞–Ω-–£–¥—ç',
    ],
    '–°–§': [
        '–í–æ–ª–æ–≥–¥–∞', '–í–æ—Ä–∫—É—Ç–∞', '–ú–æ–Ω—á–µ–≥–æ—Ä—Å–∫', '–û–ª–µ–Ω–µ–≥–æ—Ä—Å–∫', '–°–µ–≤–µ—Ä–æ–º–æ—Ä—Å–∫',
    ],
}

# ============================================================================
# –ê–≠–†–û–î–†–û–ú–´ –ö–û–¢–û–†–´–ï –ù–ï –û–ë–ï–°–ü–ï–ß–ò–í–ê–Æ–¢–°–Ø –ñ–ò–õ–¨–ï–ú –ú–û –†–§
# ============================================================================
AERODROMES_NOT_PROVIDED = {
    '–¶–í–û': [
        '–ë–∞—Ä–Ω–∞—É–ª', '–ë–µ—Ä–¥—Å–∫', '–ë—Ä–∞—Ç—Å–∫', '–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ö–∞–º–µ–Ω—Å–∫-–£—Ä–∞–ª—å—Å–∫–∏–π',
        '–ö–∞–Ω—Å–∫', '–ù–∏–∂–Ω–∏–π –¢–∞–≥–∏–ª', '–û–º—Å–∫', '–ü–µ—Ä–º—å', '–ü—É–≥–∞—á–µ–≤', '–†—Ç–∏—â–µ–≤–æ',
        '–°–∞–º–∞—Ä–∞', '–°—ã–∑—Ä–∞–Ω—å', '–¢–∞—Ç–∏—â–µ–≤–æ', '–¢–æ—Ü–∫–æ–µ', '–£–∂—É—Ä', '–£–ª—å—è–Ω–æ–≤—Å–∫',
        '–£–ø—Ä—É–Ω', '–ß–µ–±–µ–Ω—å–∫–∏', '–Ø—Å–Ω—ã–π',
    ],
    '–Æ–í–û': [
        '–ê–Ω–∞–ø–∞', '–ê—à—É–ª—É–∫', '–ë—É–¥–µ–Ω–Ω–æ–≤—Å–∫', '–í–æ–ª–≥–æ–≥—Ä–∞–¥', '–ì—Ä–æ–∑–Ω—ã–π', '–ï–π—Å–∫',
        '–ó–µ—Ä–Ω–æ–≥—Ä–∞–¥', '–ö–∞–ø—É—Å—Ç–∏–Ω –Ø—Ä', '–ö–∞—á–∞', '–ö–æ—Ä–µ–Ω–æ–≤—Å–∫', '–ö–æ—Ç–µ–ª—å–Ω–∏–∫–æ–≤–æ',
        '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä', '–ö—É—à–µ–≤—Å–∫–∞—è', '–ö—Ä—ã–º—Å–∫', '–ú–∞–π–∫–æ–ø', '–ú–æ–∑–¥–æ–∫',
        '–ú–æ—Ä–æ–∑–æ–≤—Å–∫', '–ü—Ä–∏–º–æ—Ä—Å–∫–æ-–ê—Ö—Ç–∞—Ä—Å–∫', '–¢–∞–≥–∞–Ω—Ä–æ–≥', '–¢–∏—Ö–æ—Ä–µ—Ü–∫',
    ],
    '–ó–í–û': [
        '–ë–æ—Ä–∏—Å–æ–≥–ª–µ–±—Å–∫', '–ë—É—Ç—É—Ä–ª–∏–Ω–æ–≤–∫–∞', '–í–ª–∞–¥–∏–º–∏—Ä', '–í—è–∑—å–º–∞', '–í—ã–±–æ—Ä–≥',
        '–ì—Ä–æ–º–æ–≤–æ', '–ö–∞—à', '–ö—É—Ä—Å–∫', '–õ–µ–≤–∞—à–æ–≤–æ', '–ú–∏—á—É—Ä–∏–Ω—Å–∫', '–û—Å—Ç–∞—Ñ—å–µ–≤–æ',
        '–ü–ª–µ—Å–µ—Ü–∫', '–°—Ç—É–ø–∏–Ω–æ', '–¢—É–ª–∞', '–•–æ—Ç–∏–ª–æ–≤–æ', '–®–∞—Ç–∞–ª–æ–≤–æ', '–ß–µ—Ä–Ω—è—Ö–æ–≤—Å–∫',
        '–ü–µ—Ç—Ä–æ–∑–∞–≤–æ–¥—Å–∫', '–†–∂–µ–≤',
    ],
    '–í–í–û': [
        '–ò—Ç—É—Ä—É–ø', '–ú–∞–≥–¥–∞–≥–∞—á–∏', '–ú–æ–≥–æ—á–∞', '–û–ª–æ–≤—è–Ω–Ω–∞—è', '–ü–µ—Ä–µ—è—Å–ª–∞–≤–∫–∞',
        '–°—Ä–µ–¥–Ω–µ–±–µ–ª–∞—è', '–°–æ–≤–µ—Ç—Å–∫–∞—è –ì–∞–≤–∞–Ω—å', '–°–º–∏—Ä–Ω—ã—Ö', '–¢–µ–º–ø', '–¢–∏–∫—Å–∏',
        '–•–æ—Ä–æ–ª—å', '–•—É—Ä–±–∞', '–ß–µ—Ä–Ω–∏–≥–æ–≤–∫–∞', '–ß–∏–Ω–¥–∞–Ω—Ç', '–ß–∏—Ç–∞', '–ß—É–≥—É–µ–≤–∫–∞',
    ],
    '–°–§': [
        '–ù–∞–≥—É—Ä—Å–∫–∞—è', '–ù–∞—Ä—å—è–Ω-–ú–∞—Ä', '–†–æ–≥–∞—á–µ–≤–æ', '–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫',
    ],
}

# ============================================================================
# –ü–†–ï–î–ï–õ–¨–ù–´–ï –°–£–ú–ú–´
# ============================================================================
CITY_LIMITS = {
    '–ú–æ—Å–∫–≤–∞': 4500,
    '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': 4500,
    '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': 4000,
    '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': 4000,
    '–ö–∞–∑–∞–Ω—å': 4000,
    '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥': 4000,
    '–ß–µ–ª—è–±–∏–Ω—Å–∫': 4000,
    '–°–∞–º–∞—Ä–∞': 4000,
    '–û–º—Å–∫': 4000,
    '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É': 4000,
    '–£—Ñ–∞': 4000,
    '–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫': 4000,
    '–ü–µ—Ä–º—å': 4000,
    '–í–æ—Ä–æ–Ω–µ–∂': 4000,
    '–í–æ–ª–≥–æ–≥—Ä–∞–¥': 4000,
}

DEFAULT_LIMIT_PROVIDED = 3500
DEFAULT_LIMIT_NOT_PROVIDED = 3000

def get_limit_for_city(city_name, is_provided):
    if is_provided:
        return CITY_LIMITS.get(city_name, DEFAULT_LIMIT_PROVIDED)
    else:
        return CITY_LIMITS.get(city_name, DEFAULT_LIMIT_NOT_PROVIDED)

def update_aerodrome_housing(cursor, city, is_provided, district):
    """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–∏–ª—å–µ - –ë–ï–ó updated_at!"""
    
    limit = get_limit_for_city(city, is_provided)
    
    if is_provided:
        housing_text = f"–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º –∂–∏–ª—å–µ–º –ø–æ –ª–∏–Ω–∏–∏ –ú–û –†–§ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç: {limit} —Ä—É–±/—Å—É—Ç–∫–∏)"
    else:
        housing_text = f"–ù–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –∂–∏–ª—å–µ–º –ú–û –†–§ (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –≥–æ—Å—Ç–∏–Ω–∏—Ü—ã: {limit} —Ä—É–±/—Å—É—Ç–∫–∏)"
    
    # ‚úÖ –£–ë–†–ê–õ–ò updated_at = NOW()
    cursor.execute("""
        UPDATE aerodromes 
        SET housing_info = %s
        WHERE (city = %s OR airport_name ILIKE %s OR name ILIKE %s)
        RETURNING id, city, airport_name
    """, (housing_text, city, f'%{city}%', f'%{city}%'))
    
    updated = cursor.fetchall()
    if updated:
        logger.info(f"‚úÖ {city} ({district}) -> {housing_text[:60]}...")
        return len(updated)
    else:
        logger.debug(f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ: {city} ({district})")
        return 0

def update_all_aerodromes():
    """–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∞—ç—Ä–æ–¥—Ä–æ–º—ã"""
    
    logger.info("üöÄ –ù–∞—á–∏–Ω–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∂–∏–ª—å–µ –¥–ª—è –∞—ç—Ä–æ–¥—Ä–æ–º–æ–≤...")
    logger.info("üìã –ù–∞ –æ—Å–Ω–æ–≤–µ –ü—Ä–∏–∫–∞–∑–∞ ‚Ññ600 –æ—Ç 31.08.2025")
    logger.info("="*70)
    
    try:
        conn = psycopg2.connect(DATABASE_URL)
        cursor = conn.cursor()
        
        total_updated = 0
        stats = {'provided': 0, 'not_provided': 0}
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∞—ç—Ä–æ–¥—Ä–æ–º—ã —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ–º –∂–∏–ª—å—è
        logger.info("\nüìç –û–ë–ù–û–í–õ–Ø–ï–ú –ê–≠–†–û–î–†–û–ú–´ –° –û–ë–ï–°–ü–ï–ß–ï–ù–ò–ï–ú –ñ–ò–õ–¨–Ø:")
        logger.info("-"*70)
        for district, cities in AERODROMES_PROVIDED.items():
            logger.info(f"\n  {district} ({len(cities)} –∞—ç—Ä–æ–¥—Ä–æ–º–æ–≤):")
            for city in cities:
                updated = update_aerodrome_housing(cursor, city, is_provided=True, district=district)
                total_updated += updated
                stats['provided'] += updated
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∞—ç—Ä–æ–¥—Ä–æ–º—ã –±–µ–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∂–∏–ª—å—è
        logger.info("\n\nüìç –û–ë–ù–û–í–õ–Ø–ï–ú –ê–≠–†–û–î–†–û–ú–´ –ë–ï–ó –û–ë–ï–°–ü–ï–ß–ï–ù–ò–Ø –ñ–ò–õ–¨–Ø:")
        logger.info("-"*70)
        for district, cities in AERODROMES_NOT_PROVIDED.items():
            logger.info(f"\n  {district} ({len(cities)} –∞—ç—Ä–æ–¥—Ä–æ–º–æ–≤):")
            for city in cities:
                updated = update_aerodrome_housing(cursor, city, is_provided=False, district=district)
                total_updated += updated
                stats['not_provided'] += updated
        
        conn.commit()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        cursor.execute("""
            SELECT 
                COUNT(*) as total,
                COUNT(CASE WHEN housing_info LIKE '%–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è%' THEN 1 END) as provided,
                COUNT(CASE WHEN housing_info LIKE '%–ù–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è%' THEN 1 END) as not_provided
            FROM aerodromes
            WHERE housing_info IS NOT NULL
        """)
        
        db_stats = cursor.fetchone()
        
        logger.info("\n" + "="*70)
        logger.info("‚úÖ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!")
        logger.info("="*70)
        logger.info(f"üìä –í—Å–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: {total_updated}")
        logger.info(f"üìä –° –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ–º –∂–∏–ª—å—è: {stats['provided']}")
        logger.info(f"üìä –ë–µ–∑ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∂–∏–ª—å—è: {stats['not_provided']}")
        logger.info(f"\nüìä –í –ë–ê–ó–ï –î–ê–ù–ù–´–•: {db_stats[0]} –∑–∞–ø–∏—Å–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π")
        logger.info("="*70)
        
        cursor.close()
        conn.close()
        
        return total_updated
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {e}")
        raise

if __name__ == "__main__":
    try:
        updated_count = update_all_aerodromes()
        logger.info(f"\n‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ {updated_count} –∞—ç—Ä–æ–¥—Ä–æ–º–æ–≤!")
    except Exception as e:
        logger.error(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
